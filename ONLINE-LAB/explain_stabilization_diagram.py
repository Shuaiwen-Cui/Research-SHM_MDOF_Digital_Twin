"""
Explanation and visualization of Stabilization Diagram
稳定图的原理和解读方法
"""
import numpy as np
import matplotlib.pyplot as plt

print("=" * 80)
print("稳定图 (Stabilization Diagram) 详解")
print("=" * 80)

print("""
1. 什么是稳定图？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

稳定图是模态识别中用于区分真实模态和虚假模态（噪声模态）的重要工具。

基本原理：
- 对不同的模型阶数（model order）进行模态识别
- 真实模态：在不同阶数下频率、阻尼比、振型保持稳定
- 虚假模态：在不同阶数下参数变化很大（不稳定）

2. 如何生成稳定图？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

步骤：
1. 选择模型阶数范围（例如：2 到 100，步长 2）
2. 对每个阶数进行模态识别，得到频率、阻尼比、振型
3. 比较相邻阶数的结果，判断是否稳定
4. 在图上标记：
   - 's' = 稳定 (stable)
   - 'u' = 不稳定 (unstable)
   - 'd' = 阻尼比稳定
   - 'v' = 振型稳定
   - 'f' = 频率稳定

3. 稳定图的横纵轴
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

横轴：频率 (Hz)
纵轴：模型阶数 (Model Order)

4. 如何判断稳定？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

对于相邻的两个模型阶数 n 和 n+Δn：

频率稳定性：
    |f_n - f_{n+Δn}| / f_n < ε_f  (例如：ε_f = 0.01 = 1%)

阻尼比稳定性：
    |ζ_n - ζ_{n+Δn}| / ζ_n < ε_ζ  (例如：ε_ζ = 0.05 = 5%)

振型稳定性（MAC值）：
    MAC(φ_n, φ_{n+Δn}) > ε_MAC  (例如：ε_MAC = 0.9)

5. 稳定图的解读
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

真实模态的特征：
✓ 在多个连续阶数下保持稳定（形成垂直的"柱子"）
✓ 频率、阻尼比、振型都稳定
✓ 通常出现在较低的模型阶数

虚假模态的特征：
✗ 只在少数阶数下出现
✗ 参数变化很大
✗ 随机分布，没有形成稳定的"柱子"

6. 示例稳定图解读
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

假设你的5DOF系统：

真实模态（应该形成稳定的柱子）：
- Mode 1: 0.86 Hz  → 在阶数 10-50 之间稳定
- Mode 2: 2.04 Hz  → 在阶数 10-50 之间稳定
- Mode 3: 3.15 Hz  → 在阶数 20-60 之间稳定
- Mode 4: 4.02 Hz  → 在阶数 30-70 之间稳定
- Mode 5: 4.57 Hz  → 在阶数 40-80 之间稳定（可能较弱）

虚假模态（噪声）：
- 随机分布的点
- 没有形成稳定的柱子
- 频率、阻尼比变化很大

7. 稳定图的优势
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ 自动识别真实模态
✓ 减少人工判断的主观性
✓ 可以识别弱模态（即使PSD不明显）
✓ 可以处理密集模态
✓ 可以估计最优模型阶数

8. 实际应用建议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 选择合适的阶数范围：
   - 最小值：2 × 模态数（至少 2×5 = 10）
   - 最大值：数据长度 / 10（例如：6000/10 = 600）
   - 步长：2 或 4

2. 设置合理的容差：
   - 频率容差：0.5% - 1%
   - 阻尼比容差：5% - 10%
   - MAC值：0.9 - 0.95

3. 选择稳定的模态：
   - 选择在多个连续阶数下都稳定的模态
   - 忽略只出现一次的模态
   - 优先选择在较低阶数就稳定的模态

""")

# 创建一个示例稳定图的说明
print("\n" + "=" * 80)
print("稳定图示例（文字版）")
print("=" * 80)
print("""
模型阶数 │ 频率分布
─────────┼─────────────────────────────────────────────────────────
   10    │  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·  ·
   20    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   30    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   40    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   50    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   60    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   70    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
   80    │  |  ·  |  ·  ·  |  ·  ·  ·  |  ·  ·  ·  ·  |  ·  ·  ·  ·
─────────┼─────────────────────────────────────────────────────────
频率(Hz) │ 0.86  2.04  3.15  4.02  4.57
         │ Mode1 Mode2 Mode3 Mode4 Mode5

说明：
- '|' = 稳定的真实模态（形成垂直柱子）
- '·' = 不稳定的虚假模态（噪声）
- 真实模态在多个连续阶数下保持稳定
- 虚假模态随机分布，没有形成稳定的柱子
""")

print("\n" + "=" * 80)
print("稳定图的关键指标")
print("=" * 80)
print("""
1. 频率稳定性 (Frequency Stability)
   - 真实模态：频率变化 < 1%
   - 虚假模态：频率变化 > 5%

2. 阻尼比稳定性 (Damping Stability)
   - 真实模态：阻尼比变化 < 10%
   - 虚假模态：阻尼比变化很大

3. 振型稳定性 (Mode Shape Stability) - MAC值
   - MAC (Modal Assurance Criterion)
   - MAC = |φ₁ᵀ·φ₂|² / (|φ₁|²·|φ₂|²)
   - 真实模态：MAC > 0.9
   - 虚假模态：MAC < 0.7

4. 稳定性计数 (Stability Count)
   - 真实模态：在多个连续阶数下稳定（例如：> 10次）
   - 虚假模态：只在少数阶数下出现（例如：< 3次）
""")

print("\n" + "=" * 80)
print("如何从稳定图选择模态？")
print("=" * 80)
print("""
步骤：
1. 找到形成垂直"柱子"的模态
2. 检查稳定性指标：
   - 频率稳定 ✓
   - 阻尼比稳定 ✓
   - 振型稳定（MAC > 0.9）✓
3. 选择在较低阶数就稳定的模态（更可靠）
4. 忽略只出现一次的模态（可能是噪声）
5. 对于你的5DOF系统，应该找到5个稳定的模态

注意事项：
- 不要选择所有模态（会有很多虚假模态）
- 不要只选择最强的模态（可能遗漏弱模态）
- 使用稳定图可以找到所有真实模态，包括弱模态（如Mode 5）
""")

